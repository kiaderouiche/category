//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_e "crypto/md5";_eb "encoding/hex";_gf "errors";_ca "fmt";_ec "github.com/unidoc/unipdf/v3/common";_f "github.com/unidoc/unipdf/v3/core";_c "image";_ag "image/png";_ga "io";_db "os";_dg "os/exec";_ee "path/filepath";_a "strings";_g "testing";);func CopyFile (src ,dst string )error {_ad ,_ab :=_db .Open (src );if _ab !=nil {return _ab ;};defer _ad .Close ();_de ,_ab :=_db .Create (dst );if _ab !=nil {return _ab ;};defer _de .Close ();_ ,_ab =_ga .Copy (_de ,_ad );return _ab ;};func _cd (_ea _f .PdfObject ,_cg map[int64 ]_f .PdfObject )error {switch _afc :=_ea .(type ){case *_f .PdfIndirectObject :_baa :=_afc ;_cd (_baa .PdfObject ,_cg );case *_f .PdfObjectDictionary :_dcc :=_afc ;for _ ,_fga :=range _dcc .Keys (){_fcb :=_dcc .Get (_fga );if _ddb ,_bg :=_fcb .(*_f .PdfObjectReference );_bg {_da ,_ffc :=_cg [_ddb .ObjectNumber ];if !_ffc {return _gf .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");};_dcc .Set (_fga ,_da );}else {_cd (_fcb ,_cg );};};case *_f .PdfObjectArray :_dga :=_afc ;for _age ,_bb :=range _dga .Elements (){if _cge ,_beb :=_bb .(*_f .PdfObjectReference );_beb {_egda ,_dfc :=_cg [_cge .ObjectNumber ];if !_dfc {return _gf .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");};_dga .Set (_age ,_egda );}else {_cd (_bb ,_cg );};};};return nil ;};var (ErrRenderNotSupported =_gf .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m"););func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;};if _ ,_ebb :=_dg .LookPath ("\u0067\u0073");_ebb !=nil {return ErrRenderNotSupported ;};return _dg .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_ca .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_fg ,_bdb :=HashFile (file1 );if _bdb !=nil {return false ,_bdb ;};_ebg ,_bdb :=HashFile (file2 );if _bdb !=nil {return false ,_bdb ;};if _fg ==_ebg {return true ,nil ;};_cb ,_bdb :=ReadPNG (file1 );if _bdb !=nil {return false ,_bdb ;};_dc ,_bdb :=ReadPNG (file2 );if _bdb !=nil {return false ,_bdb ;};if _cb .Bounds ()!=_dc .Bounds (){return false ,nil ;};return CompareImages (_cb ,_dc );};func CompareImages (img1 ,img2 _c .Image )(bool ,error ){_aba :=img1 .Bounds ();_dgf :=0;for _gag :=0;_gag < _aba .Size ().X ;_gag ++{for _ece :=0;_ece < _aba .Size ().Y ;_ece ++{_gcf ,_b ,_add ,_ :=img1 .At (_gag ,_ece ).RGBA ();_bd ,_be ,_fa ,_ :=img2 .At (_gag ,_ece ).RGBA ();if _gcf !=_bd ||_b !=_be ||_add !=_fa {_dgf ++;};};};_ege :=float64 (_dgf )/float64 (_aba .Dx ()*_aba .Dy ());if _ege > 0.0001{_ca .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_ege ,_dgf );return false ,nil ;};return true ,nil ;};func RunRenderTest (t *_g .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ){_df :=_a .TrimSuffix (_ee .Base (pdfPath ),_ee .Ext (pdfPath ));t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_aa *_g .T ){_bdd :=_ee .Join (outputDir ,_df );_ae :=_bdd +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _fd :=RenderPDFToPNGs (pdfPath ,0,_ae );_fd !=nil {_aa .Skip (_fd );};for _fde :=1;true ;_fde ++{_dea :=_ca .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_bdd ,_fde );_ba :=_ee .Join (baselineRenderPath ,_ca .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_df ,_fde ));if _ ,_dd :=_db .Stat (_dea );_dd !=nil {break ;};_aa .Logf ("\u0025\u0073",_ba );if _ ,_cac :=_db .Stat (_ba );_db .IsNotExist (_cac ){if saveBaseline {_aa .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_dea ,_ba );CopyFile (_dea ,_ba );continue ;};break ;};_aa .Run (_ca .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_fde ),func (_fb *_g .T ){_fb .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_dea ,_ba );_aef ,_ecd :=ComparePNGFiles (_dea ,_ba );if _db .IsNotExist (_ecd ){_fb .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_aef {_fb .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");};});};});};func HashFile (file string )(string ,error ){_ff ,_afd :=_db .Open (file );if _afd !=nil {return "",_afd ;};defer _ff .Close ();_ed :=_e .New ();if _ ,_afd =_ga .Copy (_ed ,_ff );_afd !=nil {return "",_afd ;};return _eb .EncodeToString (_ed .Sum (nil )),nil ;};func CompareDictionariesDeep (d1 ,d2 *_f .PdfObjectDictionary )bool {if len (d1 .Keys ())!=len (d2 .Keys ()){_ec .Log .Debug ("\u0044\u0069\u0063\u0074\u0020\u0065\u006e\u0074\u0072\u0069\u0065\u0073\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",len (d1 .Keys ()),len (d2 .Keys ()));_ec .Log .Debug ("\u0057\u0061s\u0020\u0027\u0025s\u0027\u0020\u0076\u0073\u0020\u0027\u0025\u0073\u0027",d1 .WriteString (),d2 .WriteString ());return false ;};for _ ,_fe :=range d1 .Keys (){if _fe =="\u0050\u0061\u0072\u0065\u006e\u0074"{continue ;};_fcf :=_f .TraceToDirectObject (d1 .Get (_fe ));_cc :=_f .TraceToDirectObject (d2 .Get (_fe ));if _fcf ==nil {_ec .Log .Debug ("\u00761\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};if _cc ==nil {_ec .Log .Debug ("\u00762\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};switch _bge :=_fcf .(type ){case *_f .PdfObjectDictionary :_ce ,_gd :=_cc .(*_f .PdfObjectDictionary );if !_gd {_ec .Log .Debug ("\u0054\u0079\u0070\u0065 m\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0020\u0025\u0054\u0020\u0076\u0073\u0020%\u0054",_fcf ,_cc );return false ;};if !CompareDictionariesDeep (_bge ,_ce ){return false ;};continue ;case *_f .PdfObjectArray :_gcc ,_gca :=_cc .(*_f .PdfObjectArray );if !_gca {_ec .Log .Debug ("\u00762\u0020n\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");return false ;};if _bge .Len ()!=_gcc .Len (){_ec .Log .Debug ("\u0061\u0072\u0072\u0061\u0079\u0020\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",_bge .Len (),_gcc .Len ());return false ;};for _ggc :=0;_ggc < _bge .Len ();_ggc ++{_abc :=_f .TraceToDirectObject (_bge .Get (_ggc ));_ced :=_f .TraceToDirectObject (_gcc .Get (_ggc ));if _agb ,_faa :=_abc .(*_f .PdfObjectDictionary );_faa {_gdb ,_ac :=_ced .(*_f .PdfObjectDictionary );if !_ac {return false ;};if !CompareDictionariesDeep (_agb ,_gdb ){return false ;};}else {if _abc .WriteString ()!=_ced .WriteString (){_ec .Log .Debug ("M\u0069\u0073\u006d\u0061tc\u0068 \u0027\u0025\u0073\u0027\u0020!\u003d\u0020\u0027\u0025\u0073\u0027",_abc .WriteString (),_ced .WriteString ());return false ;};};};continue ;};if _fcf .String ()!=_cc .String (){_ec .Log .Debug ("\u006b\u0065y\u003d\u0025\u0073\u0020\u004d\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0021\u0020\u0027\u0025\u0073\u0027\u0020\u0021\u003d\u0020'%\u0073\u0027",_fe ,_fcf .String (),_cc .String ());_ec .Log .Debug ("\u0046o\u0072 \u0027\u0025\u0054\u0027\u0020\u002d\u0020\u0027\u0025\u0054\u0027",_fcf ,_cc );_ec .Log .Debug ("\u0046\u006f\u0072\u0020\u0027\u0025\u002b\u0076\u0027\u0020\u002d\u0020'\u0025\u002b\u0076\u0027",_fcf ,_cc );return false ;};};return true ;};func ReadPNG (file string )(_c .Image ,error ){_gg ,_gc :=_db .Open (file );if _gc !=nil {return nil ,_gc ;};defer _gg .Close ();return _ag .Decode (_gg );};func ParseIndirectObjects (rawpdf string )(map[int64 ]_f .PdfObject ,error ){_dce :=_f .NewParserFromString (rawpdf );_ge :=map[int64 ]_f .PdfObject {};for {_dda ,_ffg :=_dce .ParseIndirectObject ();if _ffg !=nil {if _ffg ==_ga .EOF {break ;};return nil ,_ffg ;};switch _bddg :=_dda .(type ){case *_f .PdfIndirectObject :_ge [_bddg .ObjectNumber ]=_dda ;case *_f .PdfObjectStream :_ge [_bddg .ObjectNumber ]=_dda ;};};for _ ,_abe :=range _ge {_cd (_abe ,_ge );};return _ge ,nil ;};